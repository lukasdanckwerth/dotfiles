#!/bin/bash

set -x
set -u

if [ $# -eq 0 ] ; then
    echo "no arguments"
    exit 0
fi

DW_HELPER_DIR="${1}"

if [ ! -d "${DW_HELPER_DIR}" ] ; then
    echo "working directory doesnt exist: ${DW_HELPER_DIR}"
    exit 0
fi

WORK_DIR="${DW_HELPER_DIR}/raw-mp4"
OUTPUT_DIR="${DW_HELPER_DIR}/raw-mov"

echo "OUT: ${OUTPUT_DIR}"

mkdir -p "${OUTPUT_DIR}"

echo "WORK_DIR: ${WORK_DIR}"
echo "OUTPUT_DIR: ${OUTPUT_DIR}"

for FILE_NAME in $(ls "${WORK_DIR}");
do
   if [ ${FILE_NAME: -4} == ".mp4" ]; then
      
      FILE_PATH="${WORK_DIR}/${FILE_NAME}"
      
      OUTPUT_NAME="$(basename "${FILE_NAME}" .mp4).mov"
      OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

      echo "FILE_PATH: ${FILE_PATH}"
      echo "OUTPUT_PATH: ${OUTPUT_PATH}"

      continue

      if [ -f "${OUTPUT_PATH}" ]; then
         echo "file already exits: ${OUTPUT_PATH}"
      else
         echo "convert file: ${FILE_NAME}"
         /usr/local/bin/ffmpeg -hide_banner \
            -loglevel warning \
            -i "${FILE_PATH}" \
            -vcodec h264 \
            -acodec mp2 \
            "${OUTPUT_PATH}"

         if [ $? -eq 0 ]; then
            echo "removing file: ${FILE_PATH}"
            rm -rf "${FILE_PATH}"
         else
            echo "not removing file"
         fi
      fi

   else
      echo "ignoring file: ${FILE_NAME}"
   fi
done

exit 0
