#!/bin/bash

# WORK_DIR=$(pwd)
WORK_DIR="/Users/lukas/.dwhelper/raw-downloadhelper"
OUTPUT_DIR="/Users/lukas/.dwhelper/raw-mp4"
mkdir -p "${OUTPUT_DIR}"

echo "WORK_DIR: ${WORK_DIR}"
echo "OUTPUT_DIR: ${OUTPUT_DIR}"

for FILE_NAME in $(ls "${WORK_DIR}");
do
   if [ ${FILE_NAME: -4} == ".mp4" ]; then
      
      FILE_PATH="${WORK_DIR}/${FILE_NAME}"
      OUTPUT_PATH="${OUTPUT_DIR}/${FILE_NAME}"

      # echo "FILE_PATH: ${FILE_PATH}"
      # echo "OUTPUT_PATH: ${OUTPUT_PATH}"

      if [ -f "${OUTPUT_PATH}" ]; then
         echo "file already exits: ${OUTPUT_PATH}"
      else
         echo "convert file: ${FILE_PATH}"
         /usr/local/bin/ffmpeg -y \
            -hide_banner \
            -loglevel warning \
            -i "${FILE_PATH}" \
            -c:v mpeg4 \
            -c:a aac \
            -f mp4 \
            -b:v 4000k \
            -b:a 128k \
            -ac 2 \
            -mbd rd \
            -flags +mv4+aic \
            -trellis 2 \
            -cmp 2 \
            -subcmp 2 \
            -g 300 \
            -threads auto \
            -strict experimental \
            "${OUTPUT_PATH}"

         if [ $? -eq 0 ]; then
            echo "removing file: ${FILE_PATH}"
            rm -rf "${FILE_PATH}"
         else
            echo "not removing file"
         fi
      fi
   else
      echo "ignoring file: ${FILE_NAME}"
   fi
done

exit 0
